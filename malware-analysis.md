# Case 2: Malware Analysis

## ğŸ¯ Objectives
Melakukan analisis malware secara static dan dynamic untuk mengidentifikasi behavior, capabilities, dan indicators of compromise (IoC) dari sample malware yang ditemukan.

## ğŸ“– Scenario

**Tanggal Insiden:** 15 Oktober 2025
**Organisasi:** SecureBank Indonesia
**Pelapor:** Incident Response Team

### Background
SecureBank Indonesia mengalami insiden keamanan di mana beberapa workstation karyawan menunjukkan aktivitas yang mencurigakan. Antivirus mendeteksi file executable yang suspicious namun tidak dapat mengidentifikasi jenis malware dengan pasti.

Security Operations Center (SOC) telah mengisolasi sample dari sistem yang terinfeksi dan meminta Digital Forensics Team untuk melakukan analisis mendalam.

Anda sebagai Malware Analyst ditugaskan untuk:
1. Melakukan static analysis untuk identifikasi awal
2. Melakukan dynamic analysis untuk memahami behavior
3. Mengidentifikasi network indicators (C2 server, domains, IPs)
4. Extract malware capabilities dan persistence mechanisms
5. Membuat IoC yang dapat digunakan untuk detection
6. Memberikan rekomendasi remediation

## ğŸ“Š Data Source

### Recommended Public Malware Repositories:

1. **MalwareBazaar** (Recommended - Safe & Legal)
   - URL: https://bazaar.abuse.ch/
   - Format: PE files, APK, scripts
   - Safe download with API access
   - Tagged with malware families

2. **VirusShare**
   - URL: https://virusshare.com/
   - Requires registration
   - Large collection of samples

3. **Malware Traffic Analysis**
   - URL: https://www.malware-traffic-analysis.net/
   - PCAP + Malware samples
   - Real-world scenarios

### Sample Malware untuk Analisis:

Untuk case ini, gunakan salah satu dari:

#### Option 1: Emotet Sample
```
Family: Emotet (Banking Trojan)
Hash: (Download dari MalwareBazaar dengan tag "emotet")
Type: Windows PE Executable
Behavior: Credential stealing, spam distribution
```

#### Option 2: AgentTesla Sample
```
Family: AgentTesla (Spyware/RAT)
Hash: (Download dari MalwareBazaar dengan tag "agenttesla")
Type: .NET Executable
Behavior: Keylogging, screenshot capture, data exfiltration
```

#### Option 3: Lokibot Sample
```
Family: Lokibot (Info Stealer)
Hash: (Download dari MalwareBazaar dengan tag "lokibot")
Type: Windows PE Executable
Behavior: Password stealing, cryptocurrency wallet theft
```

### âš ï¸ SAFETY FIRST!

**CRITICAL WARNINGS:**
- âš ï¸ Handle malware ONLY in isolated VM environment
- âš ï¸ NEVER run malware on your personal computer
- âš ï¸ Use VirtualBox/VMware with snapshots
- âš ï¸ Disable network sharing between VM and host
- âš ï¸ Use malware analysis VM (REMnux, FlareVM)

## ğŸ” Investigation Tasks

### Task 1: Static Analysis - File Identification (20 points)

**Objectives:**
1. Calculate file hashes (MD5, SHA1, SHA256)
2. Determine file type and architecture
3. Extract strings and identify interesting patterns
4. Check VirusTotal results
5. Identify packer/obfuscation (if any)

**Tools:**
- `file`, `strings`, `md5sum`, `sha256sum`
- PEiD, Detect It Easy (DiE)
- VirusTotal
- pestudio

**Deliverables:**
- File metadata table
- Hash values
- VirusTotal report screenshot
- Packer identification

### Task 2: Static Analysis - PE Analysis (25 points)

**Objectives:**
1. Analyze PE headers and sections
2. Extract imported/exported functions
3. Identify suspicious API calls
4. Check for anti-analysis techniques
5. Extract embedded resources

**Tools:**
- PE Explorer / CFF Explorer
- pestudio
- PEview
- Resource Hacker

**Deliverables:**
- PE structure analysis
- Import table analysis (focus on suspicious APIs)
- List of embedded resources
- Anti-analysis indicators

### Task 3: Dynamic Analysis - Behavior Analysis (30 points)

**Objectives:**
1. Execute malware in sandbox
2. Monitor file system changes
3. Monitor registry changes
4. Monitor network activity
5. Capture process behavior

**Tools:**
- Cuckoo Sandbox / ANY.RUN
- Process Monitor (ProcMon)
- Process Explorer
- Regshot
- Wireshark/tcpdump

**Deliverables:**
- Execution timeline
- File system modifications
- Registry modifications
- Network connections/DNS queries
- Process tree

### Task 4: Network Analysis (15 points)

**Objectives:**
1. Identify C2 (Command & Control) servers
2. Analyze network protocols used
3. Capture beaconing patterns
4. Extract exfiltrated data (if any)
5. Identify DGA (Domain Generation Algorithm) usage

**Tools:**
- Wireshark
- Fiddler
- INetSim (fake internet services)
- FakeDNS

**Deliverables:**
- C2 IP addresses and domains
- Network protocol analysis
- Beacon timing analysis
- Captured HTTP/HTTPS requests

### Task 5: IoC Extraction & YARA Rules (10 points)

**Objectives:**
1. Compile all indicators of compromise
2. Create YARA rule for detection
3. Generate Snort/Suricata rules
4. Document TTPs using MITRE ATT&CK

**Deliverables:**
- Complete IoC list (IPs, domains, hashes, mutex names, etc.)
- YARA rule
- Network detection rules
- MITRE ATT&CK mapping

## ğŸ› ï¸ Tools Required

### Analysis Environment
```
Recommended VM: FlareVM (Windows) or REMnux (Linux)
- Download: https://github.com/mandiant/flare-vm
- Alternative: REMnux - https://remnux.org/
```

### Static Analysis Tools

1. **Basic Tools:**
   ```bash
   # File identification
   file malware.exe

   # Strings extraction
   strings malware.exe
   strings -el malware.exe  # Unicode strings

   # Hash calculation
   md5sum malware.exe
   sha256sum malware.exe
   ```

2. **PE Analysis:**
   - **pestudio** (Windows) - https://pestudio.en.lo4d.com/
   - **PE-bear** - https://github.com/hasherezade/pe-bear
   - **Detect It Easy (DiE)** - https://github.com/horsicq/Detect-It-Easy

3. **Decompilers:**
   - **IDA Free** - https://hex-rays.com/ida-free/
   - **Ghidra** - https://ghidra-sre.org/
   - **dnSpy** (for .NET) - https://github.com/dnSpy/dnSpy

### Dynamic Analysis Tools

1. **Sandbox:**
   - **ANY.RUN** (Online) - https://app.any.run/
   - **Cuckoo Sandbox** (Self-hosted)
   - **Joe Sandbox** (Online)

2. **Monitoring:**
   - **Process Monitor** - Sysinternals
   - **Process Explorer** - Sysinternals
   - **Regshot** - Registry snapshot
   - **Noriben** - Automated ProcMon analysis

3. **Network:**
   - **Wireshark**
   - **INetSim** - Fake internet services
   - **FakeDNS**

### Analysis Scripts
```bash
# Install Python tools
pip install pefile yara-python oletools
```

## ğŸ“ Analysis Guide

### Phase 1: Pre-Analysis Setup

1. **Prepare VM:**
   ```bash
   # Take snapshot before analysis
   # Name: "Clean State"

   # Disable Windows Defender (in analysis VM only!)
   # Set network to Host-Only or NAT with INetSim
   ```

2. **Setup Monitoring:**
   ```bash
   # Start ProcMon with filter for process
   # Start Wireshark on network interface
   # Take Regshot "Before" snapshot
   ```

### Phase 2: Static Analysis

1. **Basic File Info:**
   ```bash
   # Get file type
   file sample.exe

   # Calculate hashes
   md5sum sample.exe
   sha1sum sample.exe
   sha256sum sample.exe

   # Extract strings
   strings -n 8 sample.exe > strings.txt
   strings -n 8 -el sample.exe > strings_unicode.txt
   ```

2. **PE Analysis with Python:**
   ```python
   import pefile

   pe = pefile.PE('sample.exe')

   # Print imports
   for entry in pe.DIRECTORY_ENTRY_IMPORT:
       print(entry.dll.decode())
       for imp in entry.imports:
           print(f"  {imp.name.decode()}")
   ```

3. **Check VirusTotal:**
   ```bash
   # Upload hash to VirusTotal
   # Or use API
   ```

### Phase 3: Dynamic Analysis

1. **Execute and Monitor:**
   ```bash
   # Start monitoring first!
   # Then execute malware

   # Monitor for 5-10 minutes
   # Check for:
   # - New processes
   # - File system changes
   # - Registry changes
   # - Network connections
   ```

2. **Common Suspicious Behaviors:**
   - Creates files in %TEMP%, %APPDATA%
   - Modifies Run registry keys
   - Injects into processes
   - Connects to external IPs
   - Modifies system files

### Phase 4: Network Analysis

1. **Monitor Network Traffic:**
   ```bash
   # Filter for malware process in Wireshark

   # Look for:
   # - DNS queries
   # - HTTP/HTTPS requests
   # - Raw TCP connections
   # - Unusual ports
   ```

2. **Extract Network IoCs:**
   - IP addresses contacted
   - Domain names resolved
   - URLs accessed
   - User-Agent strings

## ğŸ“‹ Report Template

### 1. Executive Summary
- Malware family identification
- Risk assessment
- Impact summary
- Key recommendations

### 2. Sample Information
- File hashes (MD5, SHA1, SHA256)
- File size and type
- Compile timestamp
- VirusTotal detection ratio

### 3. Static Analysis Results
- PE structure analysis
- Strings analysis
- Imported functions
- Anti-analysis techniques detected
- Embedded resources

### 4. Dynamic Analysis Results
- Execution behavior
- File system modifications (created/modified/deleted files)
- Registry modifications
- Process injection/creation
- Persistence mechanisms

### 5. Network Analysis
- C2 servers (IP:Port)
- Domain names
- Network protocols
- Beacon intervals
- Exfiltrated data

### 6. Indicators of Compromise (IoC)
- File hashes
- IP addresses
- Domain names
- Mutex names
- Registry keys
- File paths

### 7. MITRE ATT&CK Mapping
- Tactics and Techniques used
- Reference: https://attack.mitre.org/

### 8. Detection & Prevention
- YARA rules
- Snort/Suricata rules
- Host-based detection
- Network-based detection

### 9. Recommendations
- Immediate remediation steps
- Long-term prevention measures
- Security controls to implement

## ğŸ“ Learning Outcomes

Setelah menyelesaikan case ini:
- âœ… Mampu melakukan static analysis pada PE files
- âœ… Menggunakan sandbox untuk dynamic analysis
- âœ… Mengidentifikasi malware behavior patterns
- âœ… Extract network indicators dari malware
- âœ… Membuat detection rules (YARA, Snort)
- âœ… Map malware behavior ke MITRE ATT&CK

## ğŸ’¡ Analysis Tips

### Static Analysis Tips:
1. **Always check strings first** - Quick wins for URLs, IPs, file paths
2. **Look for anti-analysis** - IsDebuggerPresent, Sleep, VM detection
3. **Identify crypto functions** - URLDownloadToFile, InternetOpen, etc.
4. **Check for packing** - High entropy, small import table

### Dynamic Analysis Tips:
1. **Take VM snapshot before execution**
2. **Monitor with multiple tools** - Cross-validate findings
3. **Use timeout** - Some malware delays execution
4. **Check alternate data streams** - Hidden files
5. **Look for process hollowing** - Legitimate process acting suspicious

### Network Analysis Tips:
1. **Setup fake C2** - Use INetSim to capture requests
2. **Monitor DNS first** - Shows C2 domains
3. **Check for DGA** - Random-looking domains
4. **Analyze SSL/TLS** - Certificate details can be IoC

## âš ï¸ Common Mistakes

- âŒ Running malware on host machine
- âŒ Not taking VM snapshots
- âŒ Missing persistence mechanisms
- âŒ Incomplete IoC documentation
- âŒ Not checking packed/obfuscated code
- âŒ Ignoring anti-VM techniques

## ğŸ“š Additional Resources

### Malware Analysis Resources:
- **Practical Malware Analysis** (Book)
- **Malware Analyst's Cookbook** (Book)
- **ANY.RUN Blog** - Real analysis examples
- **MalwareBytes Labs** - Threat intelligence

### YARA Rule Writing:
- https://yara.readthedocs.io/
- https://github.com/Yara-Rules/rules

### MITRE ATT&CK:
- https://attack.mitre.org/
- https://mitre-attack.github.io/attack-navigator/

## ğŸ“¤ Submission

Structure:
```
case-2-submission/
â”œâ”€â”€ report/
â”‚   â”œâ”€â”€ main-report.pdf
â”‚   â”œâ”€â”€ executive-summary.pdf
â”‚   â””â”€â”€ technical-appendix.pdf
â”œâ”€â”€ evidence/
â”‚   â”œâ”€â”€ screenshots/
â”‚   â”œâ”€â”€ procmon-logs/
â”‚   â”œâ”€â”€ pcap-files/
â”‚   â””â”€â”€ strings-output/
â”œâ”€â”€ ioc/
â”‚   â”œâ”€â”€ ioc-list.csv
â”‚   â”œâ”€â”€ yara-rules/
â”‚   â””â”€â”€ snort-rules/
â””â”€â”€ tools/
    â””â”€â”€ analysis-scripts/
```

**Deadline:** 3 minggu dari pemberian tugas
**Format:** ZIP file dengan nama: `Case2_NamaAnda_NIM.zip`
**Password:** `infected` (standard for malware samples)

---

**Remember: Safety first! Always analyze malware in isolated environments! ğŸ”’**
